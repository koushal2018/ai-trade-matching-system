
This solution extracts trade data from PDF documents, processes the information, and stores it in DynamoDB tables for trade matching between Bank and Counterparty records. The system uses a serverless architecture with S3, Lambda, and DynamoDB, powered by Amazon Bedrock Claude 3.5 Sonnet for PDF data extraction.


### Components:

1. **S3 Buckets**: 
   - `/BANK/` folder: Stores Bank PDFs
   - `/COUNTERPARTY/` folder: Stores Counterparty PDFs
   - `/extracted/` folder: Stores JSON results

2. **Lambda Function**: 
   - Triggered by S3 uploads
   - Extracts data from PDFs using Claude
   - Saves to corresponding DynamoDB table

3. **DynamoDB Tables**:
   - `BankTradeData`: Stores trades from Bank PDFs
   - `CounterpartyTradeData`: Stores trades from Counterparty PDFs

4. **Amazon Bedrock**:
   - Claude 3.5 Sonnet for PDF data extraction

## Implementation Details

### JSON Schema for Trade Fields

```json
{
  "trade_matching_attributes": {
    "primary_identifiers": {
      "fields": ["global_uti", "trade_id", "internal_reference"]
    },
    "economic_terms": {
      "dates": {
        "fields": ["trade_date", "effective_date", "termination_date"]
      },
      "quantities": {
        "fields": ["total_notional_quantity", "unit_of_measure"]
      },
      "pricing": {
        "fields": ["fixed_price", "currency", "price_unit"]
      }
    },
    "product_details": {
      "fields": ["commodity_type", "settlement_type", "business_days_convention"]
    },
    "counterparty_information": {
      "fields": ["buyer_legal_entity", "seller_legal_entity"]
    }
  }
}
```

### Lambda Function

The Lambda function performs several key tasks:
1. Determines source type from S3 path
2. Extracts data from PDF using Claude 3.5 Sonnet
3. Normalizes data and converts float values to Decimal for DynamoDB
4. Stores extracted data in S3 as JSON
5. Saves data to the appropriate DynamoDB table

## Setup and Configuration

### Prerequisites

1. AWS Account with permissions for S3, Lambda, DynamoDB, and Bedrock
2. Claude 3.5 Sonnet model enabled in your AWS region
3. S3 bucket: `fab-otc-reconciliation-deployment`

### Step 1: Create DynamoDB Tables

Create two tables with this structure:

**BankTradeData**
- Partition Key: `trade_id` (String)
- Sort Key: `internal_reference` (String)

**CounterpartyTradeData**
- Partition Key: `trade_id` (String)
- Sort Key: `internal_reference` (String)

### Step 2: Create Lambda Function

1. Create a new Lambda function named `trade-pdf-processor`
2. Set runtime to Python 3.9 or later
3. Set memory to 2048 MB
4. Set timeout to 300 seconds (5 minutes)

### Step 3: Lambda Environment Variables

Set these environment variables:
- `BANK_TABLE`: BankTradeData
- `COUNTERPARTY_TABLE`: CounterpartyTradeData
- `OUTPUT_BUCKET`: fab-otc-reconciliation-deployment

### Step 4: Lambda IAM Permissions

Ensure the Lambda role has these permissions:
- S3 GetObject for `/BANK/` and `/COUNTERPARTY/` folders
- S3 PutObject for `/extracted/` folder
- S3 ListBucket for the bucket
- DynamoDB PutItem for both tables
- Bedrock InvokeModel for Claude 3.5 Sonnet
- CloudWatch Logs

### Step 5: S3 Trigger Setup

Configure two separate S3 triggers:
1. Path: `/BANK/*.pdf`
2. Path: `/COUNTERPARTY/*.pdf`

## Code Overview

The Lambda function includes these key components:

1. **Schema Loading**: Loads the field schema for extraction
2. **Source Detection**: Determines if a document is from Bank or Counterparty
3. **PDF Extraction**: Uses Claude 3.5 Sonnet for data extraction
4. **Data Normalization**: Handles data type conversion and standardization
5. **DynamoDB Integration**: Stores data in the appropriate table
6. **Error Handling**: Comprehensive error handling and logging

## Challenges and Solutions

### Challenge 1: Lambda Timeout
- **Issue**: Default Lambda timeout is too short for Claude processing
- **Solution**: Increased timeout to 5 minutes and memory to 2048 MB

### Challenge 2: DynamoDB Float Type
- **Issue**: DynamoDB doesn't accept Python float types
- **Solution**: Implemented conversion from float to Decimal type

### Challenge 3: S3 Event Rules
- **Issue**: Overlapping S3 event rules caused conflicts
- **Solution**: Created distinct rules for each folder path

## Testing

To test the system:
1. Upload a PDF to the `/BANK/` folder
2. Check CloudWatch Logs for successful processing
3. Verify JSON extraction in the `/extracted/bank/` folder
4. Confirm data appears in the BankTradeData table
5. Repeat for Counterparty PDFs

## Next Steps

For the complete trade matching system:
1. Implement a matching agent to compare records from both tables
2. Create a UI for reviewing and approving matches
3. Implement reporting and analytics
4. Add notification system for matches and exceptions

---

This documentation covers the implementation of the PDF extraction and DynamoDB storage components of the trade matching system. The matching logic component would be implemented separately as discussed.