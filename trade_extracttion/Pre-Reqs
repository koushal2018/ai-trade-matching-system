Create the Lambda Function in AWS Console
Name: trade-pdf-processor
Runtime: Python 3.9 or newer
Architecture: x86_64
Timeout: 120 seconds (Claude vision processing takes time)
Memory: 2048 MB (recommended for processing PDFs)
Configure Environment Variables
Code
BANK_TABLE=BankTradeData
COUNTERPARTY_TABLE=CounterpartyTradeData
OUTPUT_BUCKET=fab-otc-reconciliation-deployment
Set up S3 Trigger
Event type: ObjectCreated
Prefix: Set to match your structure (e.g., "BANK/" and "COUNTERPARTY/")
Suffix: .pdf
Required IAM Permissions
Create a role with the following policy:
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Action": [
        "s3:GetObject"
      ],
      "Resource": [
        "arn:aws:s3:::fab-otc-reconciliation-deployment/BANK/*",
        "arn:aws:s3:::fab-otc-reconciliation-deployment/COUNTERPARTY/*"
      ]
    },
    {
      "Effect": "Allow",
      "Action": [
        "s3:PutObject"
      ],
      "Resource": [
        "arn:aws:s3:::fab-otc-reconciliation-deployment/extracted/*"
      ]
    },
    {
      "Effect": "Allow",
      "Action": [
        "dynamodb:PutItem"
      ],
      "Resource": [
        "arn:aws:dynamodb:*:*:table/BankTradeData",
        "arn:aws:dynamodb:*:*:table/CounterpartyTradeData"
      ]
    },
    {
      "Effect": "Allow",
      "Action": [
        "bedrock:InvokeModel"
      ],
      "Resource": "arn:aws:bedrock:us-west-2::foundation-model/anthropic.claude-3-5-sonnet-20241022-v2:0"
    },
    {
      "Effect": "Allow",
      "Action": [
        "logs:CreateLogGroup",
        "logs:CreateLogStream",
        "logs:PutLogEvents"
      ],
      "Resource": "arn:aws:logs:*:*:*"
    }
  ]
}

Create DynamoDB Tables
You'll need two tables with this structure:
BankTradeData
Primary Key: trade_id (String)
Sort Key: internal_reference (String)
GSIs:
GlobalUtiIndex (partition key: global_uti)
MatchStatusIndex (partition key: matched_status)
CounterpartyTradeData
Same structure as BankTradeData