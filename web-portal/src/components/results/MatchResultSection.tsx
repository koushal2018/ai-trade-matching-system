import { FC, useState, useEffect } from 'react'
import {
  Container,
  Header,
  SpaceBetween,
  Box,
  Icon,
  Badge,
  ProgressBar,
  ColumnLayout,
  Table,
  StatusIndicator,
  ButtonGroup,
  Alert,
  Spinner,
  Button,
  type ProgressBarProps,
} from '@cloudscape-design/components'
import { useQuery, useMutation, useQueryClient } from '@tanstack/react-query'
import { workflowService } from '../../services/workflowService'
import type { MatchResult, FieldComparison } from '../../types'

export interface MatchResultSectionProps {
  sessionId: string
}

/**
 * Get ProgressBar status based on confidence score
 * ISSUE 3 FIX: Enhanced confidence score mapping with all ranges
 * - 85%+ = success (MATCHED)
 * - 70-84% = in-progress (PROBABLE_MATCH)
 * - 50-69% = in-progress (REVIEW_REQUIRED)
 * - <50% = error (BREAK)
 */
function getProgressStatus(score: number): ProgressBarProps.Status {
  if (score >= 85) return 'success'
  if (score >= 70) return 'in-progress'
  if (score >= 50) return 'in-progress'
  return 'error'
}

/**
 * Get result text based on confidence score
 * ISSUE 3 FIX: All confidence ranges with descriptive text
 */
function getResultText(score: number): string {
  if (score >= 85) return 'High confidence - Auto-approved'
  if (score >= 70) return 'Moderate confidence - Review recommended'
  if (score >= 50) return 'Low confidence - Manual review required'
  return 'Very low confidence - Likely mismatch'
}

/**
 * MatchResultSection Component
 * 
 * Displays AI-generated matching results with GenAI output labeling pattern.
 * Implements CloudScape GenAI patterns:
 * - Output labeling with gen-ai icon and "Generated by AI" text
 * - User feedback mechanism with ButtonGroup (thumbs up/down)
 * - Confidence scoring with enhanced mapping
 * - Field-level comparison table
 * 
 * Requirements: 5.1, 7.1, 7.2, 7.3, 7.4, 7.5, 7.6, 7.7, 7.8, 8.1, 8.2, 8.3
 */
export const MatchResultSection: FC<MatchResultSectionProps> = ({ sessionId }) => {
  const [feedbackSubmitted, setFeedbackSubmitted] = useState(false)
  const [lastUpdated, setLastUpdated] = useState<Date>(new Date())
  const queryClient = useQueryClient()

  // Fetch match result
  const { data: resultResponse, isLoading, refetch, isFetching } = useQuery({
    queryKey: ['workflow', sessionId, 'result'],
    queryFn: () => workflowService.getMatchResult(sessionId),
    enabled: !!sessionId,
    refetchInterval: (query) => {
      // Poll every 30 seconds if result not available yet
      const data = query.state.data
      return data?.available ? false : 30000
    },
  })

  // Update last updated timestamp when data changes
  useEffect(() => {
    if (resultResponse) {
      setLastUpdated(new Date())
    }
  }, [resultResponse])

  // Handle refresh (Requirement 10.3, 10.4, 10.5)
  const handleRefresh = () => {
    refetch()
  }

  // Submit feedback mutation
  const { mutate: submitFeedback, isPending: isSubmittingFeedback } = useMutation({
    mutationFn: (rating: 'positive' | 'negative') =>
      workflowService.submitFeedback({ sessionId, rating }),
    onSuccess: () => {
      setFeedbackSubmitted(true)
      // Invalidate feedback-related queries if needed
      queryClient.invalidateQueries({ queryKey: ['workflow', sessionId, 'feedback'] })
    },
  })

  // Handle feedback button click
  const handleFeedback = (feedbackType: 'thumbs-up' | 'thumbs-down') => {
    const rating = feedbackType === 'thumbs-up' ? 'positive' : 'negative'
    submitFeedback(rating)
  }

  // Loading state
  if (isLoading) {
    return (
      <Container>
        <Box textAlign="center" padding="xxl">
          <Spinner size="large" />
          <Box variant="p" color="text-body-secondary" margin={{ top: 's' }}>
            Loading matching results...
          </Box>
        </Box>
      </Container>
    )
  }

  // No result available yet
  if (!resultResponse?.available || !resultResponse.result) {
    return (
      <Container>
        <Box textAlign="center" padding="xxl">
          <Box variant="h3" color="text-body-secondary">
            No matching results
          </Box>
          <Box variant="p" color="text-body-secondary" margin={{ top: 's' }}>
            Upload trade confirmations and invoke matching to see results.
          </Box>
        </Box>
      </Container>
    )
  }

  const result = resultResponse.result

  // Match status configuration
  const matchStatusConfig: Record<
    MatchResult['matchStatus'],
    { color: 'green' | 'blue' | 'red'; label: string }
  > = {
    MATCHED: { color: 'green', label: 'Matched' },
    PARTIAL_MATCH: { color: 'blue', label: 'Partial Match' },
    MISMATCHED: { color: 'red', label: 'Mismatched' },
  }

  const statusConfig = matchStatusConfig[result.matchStatus]
  const progressStatus = getProgressStatus(result.confidenceScore)
  const resultText = getResultText(result.confidenceScore)

  return (
    <Container
      header={
        <Header
          variant="h2"
          description="AI-powered trade confirmation matching analysis"
          actions={
            <Button
              iconName="refresh"
              onClick={handleRefresh}
              loading={isFetching}
              ariaLabel="Refresh matching results"
            >
              Refresh
            </Button>
          }
        >
          <SpaceBetween direction="horizontal" size="xs">
            <Box variant="span">Matching Results</Box>
            <Icon name="gen-ai" size="medium" />
            <Box variant="small" color="text-body-secondary">
              Generated by AI
            </Box>
          </SpaceBetween>
        </Header>
      }
    >
      <SpaceBetween size="l">
        {/* Match Summary */}
        <ColumnLayout columns={3} variant="text-grid">
          <SpaceBetween size="xs">
            <Box variant="awsui-key-label">Match Status</Box>
            <Badge color={statusConfig.color}>{statusConfig.label}</Badge>
          </SpaceBetween>

          <SpaceBetween size="xs">
            <Box variant="awsui-key-label">Confidence Score</Box>
            <ProgressBar
              value={result.confidenceScore}
              label={`${result.confidenceScore}%`}
              status={progressStatus}
              resultText={resultText}
            />
          </SpaceBetween>

          <SpaceBetween size="xs">
            <Box variant="awsui-key-label">Completed At</Box>
            <Box>{new Date(result.completedAt).toLocaleString()}</Box>
          </SpaceBetween>
        </ColumnLayout>

        {/* Field Comparison Table */}
        <Table
          columnDefinitions={[
            {
              id: 'field',
              header: 'Field',
              cell: (item: FieldComparison) => item.fieldName,
              sortingField: 'fieldName',
              isRowHeader: true,
            },
            {
              id: 'bankValue',
              header: 'Bank Value',
              cell: (item: FieldComparison) => String(item.bankValue),
            },
            {
              id: 'counterpartyValue',
              header: 'Counterparty Value',
              cell: (item: FieldComparison) => String(item.counterpartyValue),
            },
            {
              id: 'match',
              header: 'Match Status',
              cell: (item: FieldComparison) => (
                <StatusIndicator type={item.match ? 'success' : 'error'}>
                  {item.match ? 'Match' : 'Mismatch'}
                </StatusIndicator>
              ),
            },
            {
              id: 'confidence',
              header: 'Confidence',
              cell: (item: FieldComparison) => `${item.confidence}%`,
            },
          ]}
          items={result.fieldComparisons}
          loadingText="Loading comparison..."
          stickyHeader
          stripedRows
          wrapLines={false}
          empty={
            <Box textAlign="center" color="inherit">
              <b>No field comparisons</b>
            </Box>
          }
          header={<Header>Field-Level Comparison</Header>}
        />

        {/* User Feedback with ButtonGroup (ISSUE 8 FIX - GenAI Pattern) */}
        {!feedbackSubmitted && (
          <Box>
            <Box variant="awsui-key-label" margin={{ bottom: 'xs' }}>
              Was this result helpful?
            </Box>
            <ButtonGroup
              variant="icon"
              ariaLabel="Match feedback"
              items={[
                {
                  type: 'icon-button',
                  id: 'thumbs-up',
                  iconName: 'thumbs-up',
                  text: 'Helpful',
                  disabled: feedbackSubmitted || isSubmittingFeedback,
                },
                {
                  type: 'icon-button',
                  id: 'thumbs-down',
                  iconName: 'thumbs-down',
                  text: 'Not helpful',
                  disabled: feedbackSubmitted || isSubmittingFeedback,
                },
              ]}
              onItemClick={({ detail }) =>
                handleFeedback(detail.id as 'thumbs-up' | 'thumbs-down')
              }
            />
          </Box>
        )}

        {/* Feedback confirmation */}
        {feedbackSubmitted && (
          <Alert type="success" dismissible={false}>
            Thanks, your feedback is recorded
          </Alert>
        )}

        {/* Processing metadata */}
        <Box variant="small" color="text-body-secondary">
          Processing time: {result.metadata.processingTime}s â€¢ Agent version:{' '}
          {result.metadata.agentVersion}
        </Box>

        {/* Last updated timestamp (Requirement 10.8) */}
        <Box variant="small" color="text-body-secondary" textAlign="right">
          Last updated: {lastUpdated.toLocaleTimeString()}
        </Box>
      </SpaceBetween>
    </Container>
  )
}
