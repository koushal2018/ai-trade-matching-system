AWSTemplateFormatVersion: '2010-09-09'
Description: 'Trade Reconciliation Solution - UAE Region Master Stack'

Parameters:
  TemplateS3Bucket:
    Type: String
    Description: Name of the S3 bucket containing nested CloudFormation templates
    
  TemplateS3Path:
    Type: String
    Default: trade-reconciliation
    Description: Path prefix in the S3 bucket where templates are stored
    
  EnvironmentName:
    Type: String
    Default: dev
    Description: Environment name (dev, test, prod)
    AllowedValues:
      - dev
      - test
      - prod
  
  ApiStageName:
    Type: String
    Default: api
    Description: Name of the API Gateway stage
  
  EnableAuth:
    Type: String
    Default: 'false'
    Description: Enable Cognito authentication
    AllowedValues:
      - 'true'
      - 'false'
  
  AdminEmail:
    Type: String
    Description: Admin email address for Cognito user pool notifications
    Default: ''

  # UAE-Specific AI Provider Configuration
  AIProviderType:
    Type: String
    Default: sagemaker
    Description: AI provider to use for enhanced reconciliation (Bedrock not available in UAE)
    AllowedValues:
      - sagemaker
      - huggingface
      - none
  
  DecisionMode:
    Type: String
    Default: deterministic
    Description: Decision making approach for trade reconciliation
    AllowedValues:
      - deterministic
      - llm
      - hybrid
  
  # Fixed to UAE region
  AIProviderRegion:
    Type: String
    Default: me-central-1
    Description: AWS region for AI provider services (UAE Central)
    AllowedValues:
      - me-central-1
      - me-south-1
  
  SagemakerEndpointName:
    Type: String
    Default: ''
    Description: Sagemaker endpoint name (required when using Sagemaker provider)
  
  HuggingfaceModelName:
    Type: String
    Default: microsoft/DialoGPT-medium
    Description: Huggingface model name (when using Huggingface provider)
  
  HuggingfaceApiToken:
    Type: String
    Default: ''
    NoEcho: true
    Description: Huggingface API token (stored in Secrets Manager)
  
  ConfidenceThreshold:
    Type: Number
    Default: 0.8
    MinValue: 0.1
    MaxValue: 1.0
    Description: Confidence threshold for AI-powered matching decisions
  
  SemanticThreshold:
    Type: Number
    Default: 0.85
    MinValue: 0.1
    MaxValue: 1.0
    Description: Semantic similarity threshold for field matching
  
  EnablePerformanceOptimization:
    Type: String
    Default: 'true'
    Description: Enable performance optimization features (batching, caching)
    AllowedValues:
      - 'true'
      - 'false'

Conditions:
  EnableAuthCondition: !Equals [!Ref EnableAuth, 'true']
  HasAdminEmail: !Not [!Equals [!Ref AdminEmail, '']]
  HasPath: !Not [!Equals [!Ref TemplateS3Path, '']]
  
  # AI Provider Conditions
  UseSagemakerProvider: !Equals [!Ref AIProviderType, 'sagemaker']
  UseHuggingfaceProvider: !Equals [!Ref AIProviderType, 'huggingface']
  UseAIProvider: !Not [!Equals [!Ref AIProviderType, 'none']]
  UseLLMMode: !Or [!Equals [!Ref DecisionMode, 'llm'], !Equals [!Ref DecisionMode, 'hybrid']]
  
  # Validation Conditions
  ValidSagemakerConfig: !And [!Condition UseSagemakerProvider, !Not [!Equals [!Ref SagemakerEndpointName, '']]]
  ValidHuggingfaceConfig: !And [!Condition UseHuggingfaceProvider, !Not [!Equals [!Ref HuggingfaceApiToken, '']]]
  
  HasHuggingfaceToken: !Not [!Equals [!Ref HuggingfaceApiToken, '']]
  EnablePerformanceFeatures: !Equals [!Ref EnablePerformanceOptimization, 'true']

Rules:
  ValidateAIProviderConfiguration:
    RuleCondition: !Not [!Equals [!Ref AIProviderType, 'none']]
    Assertions:
      - Assert: !Or
          - !And [!Equals [!Ref AIProviderType, 'sagemaker'], !Not [!Equals [!Ref SagemakerEndpointName, '']]]
          - !And [!Equals [!Ref AIProviderType, 'huggingface'], !Not [!Equals [!Ref HuggingfaceApiToken, '']]]
        AssertDescription: "When using AI provider, either Sagemaker endpoint name or Huggingface API token must be provided"

Resources:
  #############################################################
  # Huggingface API Token Secret (Conditional)
  #############################################################
  HuggingfaceApiTokenSecret:
    Type: AWS::SecretsManager::Secret
    Condition: HasHuggingfaceToken
    Properties:
      Name: !Sub ${EnvironmentName}-huggingface-api-token
      Description: Huggingface API token for AI model access
      SecretString: !Sub |
        {
          "api_token": "${HuggingfaceApiToken}"
        }
      Tags:
        - Key: Environment
          Value: !Ref EnvironmentName
        - Key: Region
          Value: UAE

  #############################################################
  # Core Infrastructure Stack
  #############################################################
  CoreInfrastructureStack:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: !If
        - HasPath
        - !Sub https://s3.${AWS::Region}.amazonaws.com/${TemplateS3Bucket}/${TemplateS3Path}/core-infrastructure.yaml
        - !Sub https://s3.${AWS::Region}.amazonaws.com/${TemplateS3Bucket}/core-infrastructure.yaml
      Parameters:
        EnvironmentName: !Ref EnvironmentName
        AIProviderType: !Ref AIProviderType
        AIProviderRegion: !Ref AIProviderRegion
        UseAIProvider: !If [UseAIProvider, 'true', 'false']
        HuggingfaceSecretArn: !If [HasHuggingfaceToken, !Ref HuggingfaceApiTokenSecret, '']
      Tags:
        - Key: Environment
          Value: !Ref EnvironmentName
        - Key: Region
          Value: UAE

  #############################################################
  # Authentication Stack (Conditional)
  #############################################################
  AuthenticationStack:
    Type: AWS::CloudFormation::Stack
    Condition: EnableAuthCondition
    Properties:
      TemplateURL: !Sub https://s3.${AWS::Region}.amazonaws.com/${TemplateS3Bucket}/${TemplateS3Path}/authentication.yaml
      Parameters:
        EnvironmentName: !Ref EnvironmentName
        AdminEmail: !If [HasAdminEmail, !Ref AdminEmail, 'admin@example.com']
      Tags:
        - Key: Environment
          Value: !Ref EnvironmentName
        - Key: Region
          Value: UAE

  #############################################################
  # API and Lambda Stack
  #############################################################
  ApiLambdaStack:
    Type: AWS::CloudFormation::Stack
    DependsOn: CoreInfrastructureStack
    Properties:
      TemplateURL: !Sub https://s3.${AWS::Region}.amazonaws.com/${TemplateS3Bucket}/${TemplateS3Path}/api-lambda.yaml
      Parameters:
        EnvironmentName: !Ref EnvironmentName
        ApiStageName: !Ref ApiStageName
        CognitoUserPoolArn: !If 
          - EnableAuthCondition
          - !GetAtt AuthenticationStack.Outputs.UserPoolArn
          - ''
        # AI Provider Configuration (UAE-specific)
        AIProviderType: !Ref AIProviderType
        DecisionMode: !Ref DecisionMode
        AIProviderRegion: !Ref AIProviderRegion
        BedrockModelId: ''  # Not available in UAE
        SagemakerEndpointName: !Ref SagemakerEndpointName
        HuggingfaceModelName: !Ref HuggingfaceModelName
        HuggingfaceSecretArn: !If [HasHuggingfaceToken, !Ref HuggingfaceApiTokenSecret, '']
        ConfidenceThreshold: !Ref ConfidenceThreshold
        SemanticThreshold: !Ref SemanticThreshold
        EnablePerformanceOptimization: !Ref EnablePerformanceOptimization
      Tags:
        - Key: Environment
          Value: !Ref EnvironmentName
        - Key: Region
          Value: UAE

  #############################################################
  # Frontend Stack (Conditional)
  #############################################################
  FrontendStack:
    Type: AWS::CloudFormation::Stack
    Condition: EnableAuthCondition
    DependsOn:
      - ApiLambdaStack
      - AuthenticationStack
    Properties:
      TemplateURL: !Sub https://s3.${AWS::Region}.amazonaws.com/${TemplateS3Bucket}/${TemplateS3Path}/frontend-amplify.yaml
      Parameters:
        EnvironmentName: !Ref EnvironmentName
        ApiEndpoint: !GetAtt ApiLambdaStack.Outputs.ApiEndpoint
        UserPoolId: !GetAtt AuthenticationStack.Outputs.UserPoolId
        UserPoolClientId: !GetAtt AuthenticationStack.Outputs.UserPoolClientId
      Tags:
        - Key: Environment
          Value: !Ref EnvironmentName
        - Key: Region
          Value: UAE

  #############################################################
  # Monitoring and Alerting Stack
  #############################################################
  MonitoringStack:
    Type: AWS::CloudFormation::Stack
    DependsOn:
      - ApiLambdaStack
    Properties:
      TemplateURL: !Sub https://s3.${AWS::Region}.amazonaws.com/${TemplateS3Bucket}/${TemplateS3Path}/monitoring.yaml
      Parameters:
        EnvironmentName: !Ref EnvironmentName
        ApiGatewayId: !GetAtt ApiLambdaStack.Outputs.ApiId
        ApiHandlerFunctionName: !Sub ${EnvironmentName}-trade-reconciliation-api-handler
        DocumentProcessorFunctionName: !Sub ${EnvironmentName}-trade-reconciliation-document-processor
        ReconciliationEngineFunctionName: !Sub ${EnvironmentName}-trade-reconciliation-engine
        NotificationEmail: !If [HasAdminEmail, !Ref AdminEmail, '']
      Tags:
        - Key: Environment
          Value: !Ref EnvironmentName
        - Key: Region
          Value: UAE

  #############################################################
  # Backup and Disaster Recovery Stack
  #############################################################
  BackupDRStack:
    Type: AWS::CloudFormation::Stack
    DependsOn:
      - CoreInfrastructureStack
    Properties:
      TemplateURL: !Sub https://s3.${AWS::Region}.amazonaws.com/${TemplateS3Bucket}/${TemplateS3Path}/backup-dr.yaml
      Parameters:
        EnvironmentName: !Ref EnvironmentName
        BackupRetentionDays: 30
        PointInTimeRecoveryEnabled: 'true'
        S3ReplicationEnabled: 'true'
        DisasterRecoveryRegion: 'me-south-1'  # UAE South as DR region
      Tags:
        - Key: Environment
          Value: !Ref EnvironmentName
        - Key: Region
          Value: UAE

Outputs:
  ApiEndpoint:
    Description: URL of the API Gateway endpoint
    Value: !GetAtt ApiLambdaStack.Outputs.ApiEndpoint
  
  DashboardURL:
    Description: URL of the CloudWatch Dashboard
    Value: !GetAtt MonitoringStack.Outputs.DashboardURL
    
  BackupVaultName:
    Description: Name of the backup vault
    Value: !GetAtt BackupDRStack.Outputs.BackupVaultName
    
  DisasterRecoveryTopicArn:
    Description: ARN of the disaster recovery SNS topic
    Value: !GetAtt BackupDRStack.Outputs.DisasterRecoveryTopicArn
  
  DocumentsBucketName:
    Description: Name of the S3 bucket for document storage
    Value: !GetAtt CoreInfrastructureStack.Outputs.DocumentsBucketName
  
  AIProviderConfiguration:
    Description: AI provider configuration summary
    Value: !Sub |
      Provider: ${AIProviderType}
      Region: ${AIProviderRegion}
      Decision Mode: ${DecisionMode}
      Sagemaker Endpoint: ${SagemakerEndpointName}
  
  RegionalDeploymentInfo:
    Description: Regional deployment information
    Value: !Sub |
      Deployed in UAE region (${AWS::Region})
      AI Provider: ${AIProviderType} (Bedrock not available in UAE)
      DR Region: me-south-1
  
  UserPoolId:
    Condition: EnableAuthCondition
    Description: ID of the Cognito User Pool
    Value: !GetAtt AuthenticationStack.Outputs.UserPoolId
  
  UserPoolClientId:
    Condition: EnableAuthCondition
    Description: ID of the Cognito User Pool Client
    Value: !GetAtt AuthenticationStack.Outputs.UserPoolClientId
  
  FrontendURL:
    Condition: EnableAuthCondition
    Description: URL of the frontend hosted on Amplify
    Value: !GetAtt FrontendStack.Outputs.AmplifyAppURL