document_processing_task:
  description: >
    Convert the PDF document at {document_path} to high-quality images. Create a unique folder in ./pdf_images/ and save all images there.
  expected_output: >
    Each page converted into high-resolution JPEG images saved in a unique folder. Provide the folder path containing the images.
  agent: document_processor

trade_entity_extractor_task:
  description: >
    **CRITICAL DATA PRESERVATION & SOURCE IDENTIFICATION:** Extract comprehensive trade data from converted images maintaining ALL critical details for accurate matching and IDENTIFY THE SOURCE.
    Document Path: {document_path}
    
    **MANDATORY WORKFLOW:**
    
    1. Find and use OCR Tool on the image files created by the previous agent in ./pdf_images/ folder
    
    2. **CRITICAL: IDENTIFY TRADE SOURCE**
       Analyze the document to determine if this is a BANK trade or COUNTERPARTY trade:
       
       **BANK TRADE INDICATORS:**
       - Internal booking system screenshots or printouts
       - Trader names/IDs from your organization
       - Internal cost centers or desk codes
       - P&L information or internal risk metrics
       - "Our Reference" or similar internal terminology
       - Internal approval signatures or workflows
       - Absence of external company logos/letterheads
       
       **COUNTERPARTY TRADE INDICATORS:**
       - External company logos or letterheads (Goldman Sachs, JPMorgan, etc.)
       - "Confirmation" or "Trade Confirmation" headers
       - External reference numbers ("Your Reference")
       - Counterparty contact details and addresses
       - External legal entity names
       - Counterparty signatures or stamps
       - Standard ISDA confirmation format
    
    3. Extract and preserve ALL the following critical fields (DO NOT SIMPLIFY):
       - **TRADE_SOURCE**: "BANK" or "COUNTERPARTY" (MANDATORY FIELD)
       - Trade_ID/Reference Number/Deal ID
       - Counterparty details (name, LEI code, address, contact info)
       - Trade Date, Settlement Date, Maturity Date
       - Product details (asset class, instrument type, ISIN/CUSIP)
       - Economic terms (notional, price, rate, currency, day count)
       - Payment schedules and frequencies
       - Trade capacity (principal/agent)
       - Regulatory fields (USI, UTI, MiFID flags)
       - Settlement instructions (SSI details, account numbers)
       - Risk and margin information
       - Any additional custom fields specific to the trade type
       
    4. Structure as comprehensive JSON preserving granular detail with TRADE_SOURCE as the FIRST field
    5. Use FileWriterTool to save complete JSON to ./data/trade_data_[timestamp].json
    
    **DATA QUALITY REQUIREMENTS:**
    - ALWAYS include TRADE_SOURCE field set to either "BANK" or "COUNTERPARTY"
    - Preserve decimal precision for all amounts
    - Maintain original date formats 
    - Keep all counterparty identifiers
    - Extract complete payment schedules
    - Capture all regulatory flags
    - Retain settlement instruction details
    
    **CRITICAL:** The TRADE_SOURCE field determines database routing. Incorrect classification will break matching.
    
  expected_output: >
    Confirmation that json has been created in ./data/ directory containing:
    - TRADE_SOURCE field clearly set to "BANK" or "COUNTERPARTY"
    - Complete trade data with Trade_ID and ALL extracted fields
    - Comprehensive counterparty details including LEI codes
    - Full economic terms with decimal precision
    - Complete payment schedules and settlement instructions
    - All regulatory and compliance fields
   
  agent: trade_entity_extractor

reporting_task:
  description: >
    **CRITICAL TASK: Store trade data in the CORRECT DynamoDB table based on TRADE_SOURCE field**
    
    **TABLE SELECTION RULES (MANDATORY):**
    - IF TRADE_SOURCE = "BANK" → Store in BankTradeData table
    - IF TRADE_SOURCE = "COUNTERPARTY" → Store in CounterpartyTradeDate table
    - IF TRADE_SOURCE is missing or unclear → STOP and request clarification from previous agent
    
    **STRICT WORKFLOW (NO DEVIATIONS):**
    1. Use "List files in directory" tool to check .data/ folder for JSON files
    2. Use "Read a file's content" tool to read the FIRST JSON file found in .data/ folder (read ONCE only)
    3. Parse the JSON string into a dictionary
    4. **CRITICAL STEP: Check TRADE_SOURCE field IMMEDIATELY**
       - Extract the TRADE_SOURCE field from the JSON
       - Validate it equals either "BANK" or "COUNTERPARTY" exactly
       - If missing or invalid, STOP and report error
    
    5. **TABLE SELECTION LOGIC (NEVER DEVIATE):**
       Pseudocode for table selection:
       - if TRADE_SOURCE == "BANK": use table_name = "BankTradeData"
       - elif TRADE_SOURCE == "COUNTERPARTY": use table_name = "CounterpartyTradeDate"  
       - else: RAISE ERROR: "Invalid TRADE_SOURCE: [actual_value]. Must be BANK or COUNTERPARTY"
    
    6. **VERIFICATION BEFORE STORAGE:**
       - Log: "Preparing to store [source_type] trade in [table_name]"
       - Double-check the table selection is correct
       - If any doubt, STOP and ask for clarification
    
    **DATA STORAGE REQUIREMENTS:**
    - Use Trade_ID as the primary key for storage
    - If Trade_ID exists, update the record; if not, insert a new record
    - Include TRADE_SOURCE field in the stored record for audit trail
    - Ensure idempotent operations to prevent duplicates
    - Maintain data integrity and accuracy during storage
    - Log each storage action with timestamp, TRADE_SOURCE, and table name
    
    **ERROR HANDLING:**
    - If TRADE_SOURCE is missing: "ERROR: TRADE_SOURCE field not found in JSON. Cannot determine correct table."
    - If TRADE_SOURCE is invalid: "ERROR: Invalid TRADE_SOURCE value: [actual_value]. Expected BANK or COUNTERPARTY."
    - If wrong table detected: "CRITICAL ERROR: Found [source_type] trade incorrectly stored in [wrong_table_name]."
    
    **CONFIRMATION MESSAGE FORMAT:**
    "Successfully stored [source_type] trade [Trade_ID] in [table_name] table"
    
  expected_output: >
    Confirmation of successful storage containing:
    - "Stored [source_type] trade [Trade_ID] in [table_name]"
    - "Verification: BANK trades → BankTradeData, COUNTERPARTY trades → CounterpartyTradeDate"
    - "Action: [inserted/updated]"
    - Database record count
    - NO additional commentary or suggestions
    
  agent: reporting_analyst
  
matching_task:
  description: >
    **CRITICAL TRADE MATCHING TASK - VERIFY CORRECT TABLE STORAGE FIRST**
    
    **STEP 0: CRITICAL VERIFICATION (MUST DO FIRST)**
    Before ANY matching attempts, verify data integrity:
    1. Check BankTradeData table - ALL records should have TRADE_SOURCE = "BANK"
    2. Check CounterpartyTradeDate table - ALL records should have TRADE_SOURCE = "COUNTERPARTY"
    3. If ANY trades are in wrong tables:
       - STOP IMMEDIATELY
       - Flag as CRITICAL ERROR
       - Report: "CRITICAL: Found [source_type] trades in wrong table [table_name]"
       - Demand correction before proceeding
    
    **ONLY PROCEED IF DATA IS CORRECTLY STORED**
    
    You need to match trades stored in DynamoDB Tables BankTradeData and CounterpartyTradeDate
    If the tables do not exist or are empty, return an error message indicating the issue or ask the previous agent to populate them.
    
    **USE YOUR VETERAN EXPERTISE TO:**
    
    1. **VERIFY DATA INTEGRITY FIRST:**
       - Confirm ALL bank trades are in BankTradeData
       - Confirm ALL counterparty trades are in CounterpartyTradeDate
       - Flag any misplaced trades as CRITICAL ERRORS
       - DO NOT attempt matching if trades are in wrong tables
    
    2. **ANALYZE DATA STRUCTURES:**
       - Examine both databases to understand their schemas and field naming conventions
       - Identify which fields map between systems (e.g., "Trade ID" vs "Reference Number")
       - Recognize counterparty-specific formatting patterns you've seen in your 20 years
       - Document any data quality issues or missing critical fields
    
    3. **APPLY PROFESSIONAL MATCHING LOGIC:**
       - Match ONLY between BankTradeData and CounterpartyTradeDate (never within same table)
       - Use your knowledge of what constitutes a match vs a break in real trading operations
       - Apply appropriate tolerances based on asset class and field type
       - Recognize rounding differences vs real discrepancies
       - Identify systematic booking problems vs one-off errors
    
    4. **PERFORM INTELLIGENT MATCHING:**
       - For each trade in BankTradeData, find potential matches in CounterpartyTradeDate
       - Apply ISDA standards and regional market conventions
       - Recognize when seeming differences are actually identical
       - Flag true exceptions that need escalation
       - Handle each asset class with its specific matching requirements
    
    5. **VALIDATE WITH PROFESSIONAL SKEPTICISM:**
       - A 100% match rate is a RED FLAG - real-world matching NEVER achieves this
       - Question any matching logic that produces unrealistic results
       - Apply the "smell test" - does this match make business sense?
       - Consider counterparty relationships and their typical error patterns
    
    6. **CLASSIFY MATCHES PROFESSIONALLY:**
       Based on your experience, categorize each trade comparison as:
       - MATCHED: Bank and counterparty trades align within tolerances
       - PROBABLE MATCH: Minor discrepancies between bank and counterparty versions
       - REVIEW REQUIRED: Discrepancies need human investigation
       - BREAK: Clear mismatch between bank and counterparty records
       - DATA ERROR: Trades in wrong tables or missing source identification
    
  expected_output: >
    **PROFESSIONAL MATCHING REPORT DELIVERABLES:**
    
    1. **DATA INTEGRITY CHECK:**
       - Confirmation that all BANK trades are in BankTradeData
       - Confirmation that all COUNTERPARTY trades are in CounterpartyTradeDate
       - Any data integrity issues found and corrected
    
    2. **EXECUTIVE SUMMARY:**
       - Overall match rate between bank and counterparty trades
       - Key concerns or systematic issues identified
       - Comparison to typical match rates (70-95% expected)
       - Immediate actions required for T+1 settlement
    
    3. **DATABASE UPDATES:**
       Update TradeMatches table with:
       - Bank Trade ID and Counterparty Trade ID pairs
       - Match status and confidence scores
       - Specific field-level differences
       - Risk assessment for unmatched trades
    
    4. **DETAILED ANALYSIS REPORT:**
       Save to ./data/matching_report_[timestamp].md containing:
       - Matched bank-to-counterparty trade pairs
       - Unmatched bank trades (no counterparty confirmation)
       - Unmatched counterparty trades (no bank record)
       - Field-level break analysis
       - Pattern recognition findings
       - Recommendations based on experience
    
    Message: "Matching completed between BankTradeData and CounterpartyTradeDate. 
    Match rate: [X%]. Report saved to ./data/matching_report_[timestamp].md"
    
  agent: matching_analyst